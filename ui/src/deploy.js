const Tx = require('ethereumjs-tx').Transaction;
const Web3 = require('web3');

// const web3 = new Web3('https://ropsten.infura.io/v3/76ba732d07064c4ab4178385fc6c005f');
const web3 = new Web3('http://localhost:8545');

const account1 = '0x6bbe6b9946B280a633Bc424BdA575132E95d1695';
// const pK1 = Buffer.from('0xc39b1962b1910e8724095df3e3cb41150d6a6f1c0739a9869db1b195facee6c9');
const pK1 = Buffer.from('dda520c88004cb0b8a9e4cea64c55bd0a124571419bff59d872b300660a9e389', 'hex');

// web3.eth.getTransactionCount(account1, (err, txCount) => {
//   // Smart contract data
//   // Fetch the compiled code from the backend

//   // This is some form of slightely chnaged bytecode
//   const data = '0x608060405234801561001057600080fd5b5060c78061001f6000396000f3fe6080604052348015600f57600080fd5b506004361060325760003560e01c80636057361d146037578063b05784b8146062575b600080fd5b606060048036036020811015604b57600080fd5b8101908080359060200190929190505050607e565b005b60686088565b6040518082815260200191505060405180910390f35b8060008190555050565b6000805490509056fea26469706673582212208dea039245bf78c381278382d7056eef5083f7d243d8958817ef447e0a403bd064736f6c63430006060033';

//   // Create transaction object
//   const txObject = {
//     nonce: web3.utils.toHex(txCount),
//     // How to minimize this
//     gasLimit: web3.utils.toHex(1000000),
//     // How to minimize this
//     gasPrice: web3.utils.toHex(web3.utils.toWei('10', 'gwei')),
//     data,
//   };

//   // Sign the transaction
//   const tx = new Tx(txObject, { chain: 'ropsten' });
//   tx.sign(pK1);

//   const serializedTx = tx.serialize();
//   const raw = `0x${serializedTx.toString('hex')}`;

//   // Broadcast the tranasction
//   web3.eth.sendSignedTransaction(raw, (err, txHash) => {
//     console.log('err:', err, 'txHash', txHash);
//     // Use this txHash to find the contract on Etherscan
//   });
// });

// object from the backend
export default function deploy(object) {
  // TODO: The first param is errror _ log it
  web3.eth.getTransactionCount(account1, (_, txCount) => {
    // Smart contract data
    // Fetch the compiled code from the backend

    // Create transaction object
    const txObject = {
      nonce: web3.utils.toHex(txCount),
      // How to minimize this
      gasLimit: web3.utils.toHex(1000000),
      // How to minimize this
      gasPrice: web3.utils.toHex(web3.utils.toWei('10', 'gwei')),
      data: object,
    };

    // Sign the transaction
    const tx = new Tx(txObject, { chain: 'ropsten' });
    tx.sign(pK1);

    const serializedTx = tx.serialize();
    const raw = `0x${serializedTx.toString('hex')}`;

    // Broadcast the tranasction
    web3.eth.sendSignedTransaction(raw, (err, txHash) => {
      console.log('err:', err, 'txHash', txHash);
      // Use this txHash to find the contract on Etherscan
    });
  });
}

const data =  '60806040523480156200001157600080fd5b5060405162001abb38038062001abb8339818101604052810190620000379190620004fb565b33600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550806004908051906020019062000090929190620003f0565b506200010d6040518060400160405280600581526020017f4d6172656b0000000000000000000000000000000000000000000000000000008152506040518060400160405280600781526020017f4b7261c59b6b6f000000000000000000000000000000000000000000000000008152506200028860201b60201c565b620001896040518060400160405280600781526020017f4d69636861c582000000000000000000000000000000000000000000000000008152506040518060400160405280600d81526020017f4b6f64c582756261c584736b69000000000000000000000000000000000000008152506200028860201b60201c565b620002056040518060400160405280600881526020017f4b7279737469616e0000000000000000000000000000000000000000000000008152506040518060400160405280600c81526020017f416e64727a656a6577736b6900000000000000000000000000000000000000008152506200028860201b60201c565b620002816040518060400160405280600681526020017f4d616369656b00000000000000000000000000000000000000000000000000008152506040518060400160405280600c81526020017f4d6f737a637a79c584736b6900000000000000000000000000000000000000008152506200028860201b60201c565b5062000704565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146200031b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620003129062000624565b60405180910390fd5b6000828260405160200162000332929190620005e9565b60405160208183030381529060405280519060200120905060006040518060800160405280858152602001848152602001838152602001600081525090806001815401808255809150506001900390600052602060002090600402016000909190919091506000820151816000019080519060200190620003b5929190620003f0565b506020820151816001019080519060200190620003d4929190620003f0565b5060408201518160020155606082015181600301555050505050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200043357805160ff191683800117855562000464565b8280016001018555821562000464579182015b828111156200046357825182559160200191906001019062000446565b5b50905062000473919062000477565b5090565b6200049c91905b80821115620004985760008160009055506001016200047e565b5090565b90565b600082601f830112620004b157600080fd5b8151620004c8620004c28262000674565b62000646565b91508082526020830160208301858383011115620004e557600080fd5b620004f2838284620006bd565b50505092915050565b6000602082840312156200050e57600080fd5b600082015167ffffffffffffffff8111156200052957600080fd5b62000537848285016200049f565b91505092915050565b60006200054d82620006a1565b620005598185620006ac565b93506200056b818560208601620006bd565b6200057681620006f3565b840191505092915050565b600062000590602983620006ac565b91507f4f6e6c7920636f6e7472616374206f776e65722063616e2063616c6c2074686960008301527f73206d6574686f646000000000000000000000000000000000000000000000006020830152604082019050919050565b6000604082019050818103600083015262000605818562000540565b905081810360208301526200061b818462000540565b90509392505050565b600060208201905081810360008301526200063f8162000581565b9050919050565b6000604051905081810181811067ffffffffffffffff821117156200066a57600080fd5b8060405250919050565b600067ffffffffffffffff8211156200068c57600080fd5b601f19601f8301169050602081019050919050565b600081519050919050565b600082825260208201905092915050565b60005b83811015620006dd578082015181840152602081019050620006c0565b83811115620006ed576000848401525b50505050565b6000601f19601f8301169050919050565b6113a780620007146000396000f3fe608060405234801561001057600080fd5b50600436106100885760003560e01c8063a69beaba1161005b578063a69beaba14610113578063e1246a781461012f578063e173730c14610162578063eb2119db1461018057610088565b806306a49fce1461008d5780633165d233146100ab5780634a386db3146100c7578063577c689a146100f7575b600080fd5b6100956101b0565b6040516100a2919061107f565b60405180910390f35b6100c560048036038101906100c09190610cb6565b6103f3565b005b6100e160048036038101906100dc9190610cb6565b6104de565b6040516100ee91906110a1565b60405180910390f35b610111600480360381019061010c9190610d08565b610534565b005b61012d60048036038101906101289190610cdf565b610693565b005b61014960048036038101906101449190610d74565b610832565b6040516101599493929190611115565b60405180910390f35b61016a61099f565b60405161017791906110bc565b60405180910390f35b61019a60048036038101906101959190610cb6565b610acd565b6040516101a791906110a1565b60405180910390f35b6060600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1661023e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161023590611168565b60405180910390fd5b6000805480602002602001604051908101604052809291908181526020016000905b828210156103ea5783829060005260206000209060040201604051806080016040529081600082018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561031c5780601f106102f15761010080835404028352916020019161031c565b820191906000526020600020905b8154815290600101906020018083116102ff57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156103be5780601f10610393576101008083540402835291602001916103be565b820191906000526020600020905b8154815290600101906020018083116103a157829003601f168201915b505050505081526020016002820154815260200160038201548152505081526020019060010190610260565b50505050905090565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610483576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161047a90611188565b60405180910390fd5b6001600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff02191690831515021790555050565b6000600360008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff169050919050565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146105c4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105bb90611188565b60405180910390fd5b600082826040516020016105d99291906110de565b6040516020818303038152906040528051906020012090506000604051806080016040528085815260200184815260200183815260200160008152509080600181540180825580915050600190039060005260206000209060040201600090919091909150600082015181600001908051906020019061065a929190610b7e565b506020820151816001019080519060200190610677929190610b7e565b5060408201518160020155606082015181600301555050505050565b600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1661071f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161071690611168565b60405180910390fd5b600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16156107ac576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107a3906111a8565b60405180910390fd5b60008090505b6000805490508110156108255781600082815481106107cd57fe5b906000526020600020906004020160020154141561081857600081815481106107f257fe5b906000526020600020906004020160030160008154809291906001019190505550610825565b80806001019150506107b2565b5061082f33610b23565b50565b6000818154811061083f57fe5b9060005260206000209060040201600091509050806000018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108eb5780601f106108c0576101008083540402835291602001916108eb565b820191906000526020600020905b8154815290600101906020018083116108ce57829003601f168201915b505050505090806001018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109895780601f1061095e57610100808354040283529160200191610989565b820191906000526020600020905b81548152906001019060200180831161096c57829003601f168201915b5050505050908060020154908060030154905084565b6060600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16610a2d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a2490611168565b60405180910390fd5b60048054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610ac35780601f10610a9857610100808354040283529160200191610ac3565b820191906000526020600020905b815481529060010190602001808311610aa657829003601f168201915b5050505050905090565b6000600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff169050919050565b6001600360008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff02191690831515021790555050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610bbf57805160ff1916838001178555610bed565b82800160010185558215610bed579182015b82811115610bec578251825591602001919060010190610bd1565b5b509050610bfa9190610bfe565b5090565b610c2091905b80821115610c1c576000816000905550600101610c04565b5090565b90565b600081359050610c328161132c565b92915050565b600081359050610c4781611343565b92915050565b600082601f830112610c5e57600080fd5b8135610c71610c6c826111f5565b6111c8565b91508082526020830160208301858383011115610c8d57600080fd5b610c988382846112d9565b50505092915050565b600081359050610cb08161135a565b92915050565b600060208284031215610cc857600080fd5b6000610cd684828501610c23565b91505092915050565b600060208284031215610cf157600080fd5b6000610cff84828501610c38565b91505092915050565b60008060408385031215610d1b57600080fd5b600083013567ffffffffffffffff811115610d3557600080fd5b610d4185828601610c4d565b925050602083013567ffffffffffffffff811115610d5e57600080fd5b610d6a85828601610c4d565b9150509250929050565b600060208284031215610d8657600080fd5b6000610d9484828501610ca1565b91505092915050565b6000610da98383610ff7565b905092915050565b6000610dbc82611231565b610dc68185611254565b935083602082028501610dd885611221565b8060005b85811015610e145784840389528151610df58582610d9d565b9450610e0083611247565b925060208a01995050600181019050610ddc565b50829750879550505050505092915050565b610e2f81611299565b82525050565b610e3e816112a5565b82525050565b610e4d816112a5565b82525050565b6000610e5e8261123c565b610e688185611265565b9350610e788185602086016112e8565b610e818161131b565b840191505092915050565b6000610e978261123c565b610ea18185611276565b9350610eb18185602086016112e8565b610eba8161131b565b840191505092915050565b6000610ed2605a83611276565b91507f596f7520617265206e6f7420616c6c6f77656420746f2070617274696369706160008301527f746520696e2074686520766f72696e6720617320796f75207075626c6963206b60208301527f657920686173206e6f74206265656e20726567697374657265640000000000006040830152606082019050919050565b6000610f5e602983611276565b91507f4f6e6c7920636f6e7472616374206f776e65722063616e2063616c6c2074686960008301527f73206d6574686f646000000000000000000000000000000000000000000000006020830152604082019050919050565b6000610fc4601683611276565b91507f596f75206861766520616c726561647920766f746564000000000000000000006000830152602082019050919050565b600060808301600083015184820360008601526110148282610e53565b9150506020830151848203602086015261102e8282610e53565b91505060408301516110436040860182610e35565b5060608301516110566060860182611061565b508091505092915050565b61106a816112cf565b82525050565b611079816112cf565b82525050565b600060208201905081810360008301526110998184610db1565b905092915050565b60006020820190506110b66000830184610e26565b92915050565b600060208201905081810360008301526110d68184610e8c565b905092915050565b600060408201905081810360008301526110f88185610e8c565b9050818103602083015261110c8184610e8c565b90509392505050565b6000608082019050818103600083015261112f8187610e8c565b905081810360208301526111438186610e8c565b90506111526040830185610e44565b61115f6060830184611070565b95945050505050565b6000602082019050818103600083015261118181610ec5565b9050919050565b600060208201905081810360008301526111a181610f51565b9050919050565b600060208201905081810360008301526111c181610fb7565b9050919050565b6000604051905081810181811067ffffffffffffffff821117156111eb57600080fd5b8060405250919050565b600067ffffffffffffffff82111561120c57600080fd5b601f19601f8301169050602081019050919050565b6000819050602082019050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b6000611292826112af565b9050919050565b60008115159050919050565b6000819050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b82818337600083830152505050565b60005b838110156113065780820151818401526020810190506112eb565b83811115611315576000848401525b50505050565b6000601f19601f8301169050919050565b61133581611287565b811461134057600080fd5b50565b61134c816112a5565b811461135757600080fd5b50565b611363816112cf565b811461136e57600080fd5b5056fea26469706673582212200d788ea544d89353dc578477c8a966d5cc85e0316c0aeb5b18c2a6eaafe4b27564736f6c634300060a0033' 

deploy(data);